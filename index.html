<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام NoteCam - تسجيل الدخول</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- الأنماط -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <div class="app-container">
        <!-- شريط الحالة -->
        <div class="status-bar" id="statusBar">
            <div id="statusText">نظام NoteCam - جاهز</div>
            <div class="sync-status" id="syncStatus">
                <i class="fas fa-wifi" id="connectionIcon"></i>
                <span id="connectionText">جارٍ الاتصال...</span>
            </div>
        </div>

        <!-- صفحة تسجيل الدخول -->
        <div class="login-page" id="loginPage">
            <div class="login-card">
                <div class="logo">
                    <i class="fas fa-camera-retro"></i>
                    <h1>نظام NoteCam</h1>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label for="username">
                            <i class="fas fa-user"></i> اسم المستخدم
                        </label>
                        <input type="text" id="username" class="form-input" 
                               placeholder="أدخل اسم المستخدم" autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i> كلمة المرور
                        </label>
                        <input type="password" id="password" class="form-input" 
                               placeholder="أدخل كلمة المرور" autocomplete="current-password">
                    </div>
                    
                    <button class="login-btn" id="loginBtn" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                    </button>
                    
                    <div class="login-info">
                        <p>نسخة النظام: 3.0.0</p>
                        <p>مزامنة مع Supabase</p>
                        <p id="serverStatus">جاري الاتصال بالخادم...</p>
                    </div>
                </div>
                
                <div class="system-info">
                    <h3>معلومات النظام:</h3>
                    <ul>
                        <li>يدعم جميع المستخدمين عالمياً</li>
                        <li>تخزين الصور في السحابة</li>
                        <li>مزامنة فورية</li>
                        <li>تقارير مفصلة</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- الإشعارات -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Scripts -->
    <script type="module">
        import { initializeSupabase, appState } from './js/config.js';
        import { authSystem } from './js/auth.js';
        import { showNotification } from './js/utils/notifications.js';
        import { syncManager } from './js/sync.js';

        // تهيئة التطبيق
        async function initializeApp() {
            // تحديث حالة الاتصال
            updateConnectionStatus();
            
            // تهيئة Supabase
            const supabase = await initializeSupabase();
            
            if (supabase) {
                document.getElementById('serverStatus').textContent = 'متصل بالخادم';
                document.getElementById('serverStatus').style.color = '#2ea043';
                
                // التحقق من الجلسة النشطة
                const hasSession = await authSystem.checkSession();
                if (hasSession) {
                    // توجيه المستخدم إلى الصفحة المناسبة
                    redirectToDashboard();
                }
                
                // بدء المزامنة التلقائية
                syncManager.startAutoSync();
            } else {
                document.getElementById('serverStatus').textContent = 'غير متصل بالخادم';
                document.getElementById('serverStatus').style.color = '#ff6b6b';
                showNotification('العمل في الوضع المحلي', 'warning');
            }
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus() {
            const connectionIcon = document.getElementById('connectionIcon');
            const connectionText = document.getElementById('connectionText');
            const statusText = document.getElementById('statusText');
            
            if (navigator.onLine) {
                connectionIcon.className = 'fas fa-wifi';
                connectionIcon.style.color = '#2ea043';
                connectionText.textContent = 'متصل بالإنترنت';
                statusText.textContent = 'نظام NoteCam - متصل';
                appState.isOnline = true;
            } else {
                connectionIcon.className = 'fas fa-wifi-slash';
                connectionIcon.style.color = '#ff6b6b';
                connectionText.textContent = 'غير متصل';
                statusText.textContent = 'نظام NoteCam - غير متصل';
                appState.isOnline = false;
            }
        }

        // تسجيل الدخول
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showNotification('الرجاء ملء جميع الحقول', 'warning');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التسجيل...';
            
            try {
                const success = await authSystem.login(username, password);
                
                if (success) {
                    showNotification('تم تسجيل الدخول بنجاح', 'success');
                    setTimeout(() => {
                        redirectToDashboard();
                    }, 1000);
                }
                
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> تسجيل الدخول';
            }
        }

        // توجيه إلى لوحة التحكم المناسبة
        function redirectToDashboard() {
            const user = authSystem.currentSession;
            
            if (user.role === 'admin') {
                window.location.href = 'admin.html';
            } else {
                window.location.href = 'employee.html';
            }
        }

        // مراقبة حالة الاتصال
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // تفعيل زر الدخول عند الضغط على Enter
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // تعريض الدوال للاستخدام العام
        window.login = login;
        // ========== إضافات Supabase ==========

const SUPABASE_CONFIG = {
    URL: 'https://jxvnmcgfwlbswtkiglmh.supabase.co',
    ANON_KEY: 'sb_publishable_2NInsIOwZjO8LurZUdI2wA_ljsWkESw',
    STORAGE_BUCKET: 'notecam-photos'
};

let supabaseClient = null;

async function initializeSupabase() {
    try {
        supabaseClient = supabase.createClient(
            SUPABASE_CONFIG.URL, 
            SUPABASE_CONFIG.ANON_KEY
        );
        
        console.log('Supabase connected');
        return supabaseClient;
    } catch (error) {
        console.error('Supabase init error:', error);
        return null;
    }
}

// نظام المزامنة المبسط
async function syncWithSupabase() {
    if (!supabaseClient) return;
    
    try {
        // مزامنة المستخدمين
        const { data: users } = await supabaseClient
            .from('users')
            .select('*');
        
        if (users && users.length > 0) {
            // تحديث البيانات المحلية
            users.forEach(user => {
                if (!usersData[user.username]) {
                    usersData[user.username] = {
                        password: user.password,
                        role: user.role,
                        name: user.name,
                        assignedAreas: user.assigned_areas || []
                    };
                }
            });
        }
        
        // مزامنة التقارير
        const { data: reports } = await supabaseClient
            .from('reports')
            .select('*')
            .order('date', { ascending: false });
        
        if (reports) {
            reports.forEach(report => {
                const zoneCode = report.area_code;
                if (!zoneReports[zoneCode]) {
                    zoneReports[zoneCode] = {
                        name: report.area,
                        reports: [],
                        photos: []
                    };
                }
                
                zoneReports[zoneCode].reports.push({
                    id: report.id,
                    employee: report.employee,
                    employeeName: report.employee_name,
                    numberBefore: report.number_before,
                    numberAfter: report.number_after,
                    date: report.date,
                    location: report.location,
                    area: report.area,
                    areaCode: report.area_code,
                    noteCode: report.note_code,
                    status: report.status,
                    step: report.step,
                    completionDate: report.completion_date,
                    photos: report.photos || []
                });
            });
        }
        
        saveToLocalStorage();
        showNotification('Données synchronisées', 'success');
        
    } catch (error) {
        console.error('Sync error:', error);
        showNotification('Erreur de synchronisation', 'error');
    }
}

// تعديل دالة حفظ البيانات
const originalSaveToLocalStorage = saveToLocalStorage;
saveToLocalStorage = function() {
    originalSaveToLocalStorage();
    
    // محاولة المزامنة مع Supabase
    if (supabaseClient) {
        setTimeout(syncWithSupabase, 1000);
    }
};

// تهيئة Supabase عند البدء
setTimeout(async () => {
    await initializeSupabase();
    if (supabaseClient) {
        syncWithSupabase();
        
        // مزامنة دورية كل 30 ثانية
        setInterval(syncWithSupabase, 30000);
    }
}, 2000);

// إضافة زر مزامنة يدوية إلى المشرف
function addSyncButtonToAdmin() {
    const syncButton = document.createElement('button');
    syncButton.className = 'action-btn';
    syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Synchroniser avec Supabase';
    syncButton.onclick = syncWithSupabase;
    
    // إضافة إلى لوحة المشرف
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
        const firstSection = adminPanel.querySelector('.dashboard-section');
        if (firstSection) {
            firstSection.insertBefore(syncButton, firstSection.firstChild);
        }
    }
}

// تشغيل بعد تحميل الصفحة
if (document.readyState === 'complete') {
    addSyncButtonToAdmin();
} else {
    document.addEventListener('DOMContentLoaded', addSyncButtonToAdmin);
}
    </script>
</body>
</html>
